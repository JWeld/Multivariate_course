---
title: "MVA Course, Questions 1-5"
output:
  html_document:
    df_print: paged
---

First we need to import the data we will be using. This is included in the "vegan" package.

```{r}
library(vegan)# Package for multivariate analyses of ecological data
library(tidyverse)
data("dune")
data("dune.env")
#Management factor is character but we need it to be numeric for some analyses. Convert to "dummy" variables...
#If you are converting a factor that is numbers already you need as.numeric(as.character(x))

#give each management method its own column
dummy_management <- as.data.frame(model.matrix( ~ Management - 1, data=dune.env )) 
#add these to the dataset
dune.env.original <- dune.env
dune.env <- dune.env %>% select(A1, Moisture, Manure, Use) %>% cbind(.,dummy_management) 
dune.env$Moisture <- as.numeric(as.character(dune.env$Moisture)) #make numeric
dune.env$Manure <- as.numeric(as.character(dune.env$Manure))
dune.env$Use <- as.numeric(dune.env$Use)
```
***
#### Question 2: Do a PCA on the environmental data related to the Dune meadow dataset.
What are the results telling you? In what way do objects/samples to the left differ from objects to the right, and at the bottom from those at the top? Which are the most important gradients in the dataset? Which descriptor variables are related, and which are unrelated? 

```{r}
env.pca <- rda(dune.env, scale = TRUE) #vegan uses the same function for PCA and RDA
biplot(env.pca)#plot the results
env.pca #summarise results
summary(eigenvals(env.pca)) #see variance explained
```
***
#### Question 3: For comparison, do also a CA on the Dune Meadow Environmental variables and compare the result with the PCA on the same data! 

Why do the results in exercise 2 and 3 differ?

```{r}
#unconstrained ordination on environmental data (CA)
env.ca <- cca(dune.env) #vegan uses the same function for CA and CCA
plot(env.ca)
env.ca
summary(eigenvals(env.ca)) #proportion variance explained
```
***
#### Question 4: Do a CA-ordination on the Dune Meadow species dataset.What are the results telling you? 

Give a conceptual description on why objects/samples and descriptors/species to the left differ from objects and descriptors to the right, and those at the bottom from those at the top! (Plant ecologists may give a more detailed description, using their knowledge about the species in the dataset).
```{r}
dune.ca <- cca(dune)
plot(dune.ca)
dune.ca
summary(eigenvals(dune.ca)) #proportion variance explained
```
***
#### Question 5: Repeat exercise 4, but with DCA ordination instead. 

Look at the eigenvalues, the length of gradient, the total variation and the ordination diagram. 
Explain the differences between results from CA and DCA.

```{r}
dune.dca <- decorana(dune)
dune.dca 
#Detrended correspondence analysis (function decorana).
#The total amount of variation is undefined in detrended 
#correspondence analysis and therefore proportions from total
#are unknown and undefined. 
#DCA is not a method for decomposition of variation, and therefore
#these proportions would not make sense either.

plot(dune.dca)

```

#### Question 21: Interpreting ordination results using species traits

Experienced plant ecologists may already have looked at the species in the Dune Meadow ordination graphs and concluded that species with similar traits occur together. This is possible if you have good knowledge about plant species ecological preferences, and if there are relatively few species in your dataset. In this exercise we will use tabulated data on species ecological preferences (the Ellenberg indicator values) to interpret the results of the ordinations. The Ellenberg indicator values are described on the first page in this booklet. Which Ellenberg values are most important for the distribution of the species? What do the different axes represent in terms of environmental gradients?

```{r}
#Ulf's version of Dune data with ellenbergs
dune.u <- read.table("Data/Data_for_R/dune.txt", sep=";",header=T,row.names=1)
dune.ell.u <- read_csv("Data/exports_from_canoco/Ellenberg.csv")
dune.mean.ell <- read_csv("Data/exports_from_canoco/meanell.csv", col_types = cols(Plot = col_skip()))
dune.env.u <- read.table("Data/Data_for_R/env.txt", sep="\t",header=T,row.names=1)

## Quick code to replace missing values with the column mean, forward selection fails with NA
## Need to tweak dune data really

dune.mean.ell.impute <- data.frame(
    sapply(
        dune.mean.ell,
        function(x) ifelse(is.na(x),
            mean(x, na.rm = TRUE),
            x)))

#CCA analysis
#create global model with CCA (including all variables) and test it's significance, and if it is significant,
#we use the ordistep function with appropriate arguments to do forward selection of variables.
cca1 <- cca(dune.u ~ ., data = dune.mean.ell.impute) # full model (with all explanatory variables)
anova(cca1) #overall model is significant
adjR2.cca <- RsquareAdj (cca1)$adj.r.squared 

# Start by make ordinations
cca0 <- cca (dune.u~ 1, data = dune.mean.ell.impute) # empty model only with intercept
cca1 <- cca(dune.u ~ ., data = dune.mean.ell.impute, na.action = na.omit) # full model (with all explanatory variables)
cca1
plot(cca1, main="CCA, all data")

#Stepwise approach, using "ordistep"
step2<-ordistep(cca0, scope = formula(cca1), perm.max=9999)
step2$anova # N F T L S sig
#alternatively
sel.osR2 <- ordiR2step (cca0, scope = formula (cca1), R2scope = adjR2.cca, direction = 'forward', permutations = 9999)
sel.osR2$anova # N F T L S sig

#or model selection using permutations
# By terms
#anova(cca1, by="term", perm.max = 200)
# By margin
#anova(cca1, by="margin", perm.max = 200)
# By axis
#anova(cca1, by="axis", perm.max = 200)

# New model with only significant explanatory variables?
cca3 <- cca(dune.u ~ N + F + T + L + S, data = dune.mean.ell.impute)
cca3
ordiplot(cca3, main = "CCA, significant variables only", type = "text")

```

#### Question 22: Decomposition of variance

In usual analysis of variance experiments, the variance is decomposed into components. The same can be done in multivariate analyses. In this exercise you will decompose the variance in the Dune meadow data set into different variance components. You will use two groups of variance components: Group 1 is Management and Group 2 is the soil variables (A1 and Moisture). In ordinations, the variance is expressed by the sum of the eigenvalues. 

The result gives you the fraction of the total variation that is explained by:
    a) uniquely by Management (effect of soil removed),
    b) uniquely by soil (effect of Management removed),
    c) jointly by Soil and Management (the interaction).
    
The total explained variation is the sum of a), b) and c). 

The total variation in the dataset is the sum of all unconstrained eigenvalues.


Perform the analyses and interpret the results!
How much of the total variation (% of All) is explained by:
- uniquely by Management (effect of Soil removed),
- uniquely by Soil  (effect of Management removed),
- jointly by Soil and Management (the interaction)
- Not by Soil or Management?

```{r}
## variance partitioning

# because management is a factor we need to convert it into 
# a dummy matrix using the function dummies::dummy
library(dummies)
management <-  dummy(dune.env.original$Management)
#management <- dune.env[,c("ManagementBF" + "ManagementHF" + "ManagementNM" + "ManagementSF")]
soil <- dune.env.original[,c("A1", "Moisture")]
# examine the explanatory variable of each class of variables.
varp <- varpart(dune, management, soil)


#varp2 <- varpart (dune, ~ ManagementBF + ManagementHF + ManagementNM + ManagementSF,
# ~ A1 + Moisture, data = dune.env)
varp
plot (varp, digits = 2, Xnames = c('Management', 'Soil'), bg = c('navy', 'tomato'))

```


#### Question 23: Diagnostic species for a priori defined groups
In this exercise we will investigate if any particular species are indicative for the four different management types. The CANOCO version of this analysis is a simplified version of these types of tests. The full versions also give significance testing and more comprehensive result presentations. See for instance IndVal by Dufresne & Legendre.
    1. Go to menu Data /Add new table(s) / Indicator values.
    2. Mark the Species data table, and Management as the factor defining groups.
    3. Opt for Indicator Value (quantitative). 
    4. Export the table to Excel to be able to sort the data to find the highest values = best indicators for a group.
Use the resulting data table to find the two top indicator species for each of the four Management types!

```{r}
library(labdsv)

iva <- indval(dune, dune.env.original$Management)
iva
summary(iva)

iva$indval

iva.df <- as.data.frame(iva$indval)
arrange(rownames_to_column(iva.df), BF)

#find best results for each management
#gr <- iva$maxcls[iva$pval<0.1]
#iv <- iva$indcls[iva$pval<0.1]
#pv <- iva$pval[iva$pval<0.1]

#indvalsummary <- data.frame(group=gr, indval=iv, pvalue=pv)
#indvalsummary <- indvalsummary[order(indvalsummary$group, -indvalsummary$indval),]
#indvalsummary

# Perform indicator species analysis based on management
library(indicspecies)
ind_species<-multipatt(dune,dune.env.original$Management,duleg=TRUE,func="IndVal",control=how(nperm=5000))
#duleg argument means site group combinations are not considered, only the original site groups
summary(ind_species)


```


#### Question 24: Analysing a time series with vegetation data

Quite often vegetation ecologists have data from repeated inventories in permanent plots. The overall question to answer is if there has been a significant and directional change in the species composition. In this exercise we have rearranged the Dune Meadow data so that it consists of only 10 plots, each analysed 2 times (same species as in all other exercises, just grouping and rearrangement of plots). We want to analyse if there has been a consistent change in species composition between the two inventories. We are thus not interested in differences between the ten plots. 

```{r}

```


#### Question 25: A multivariate Before-After-Control- Impact (BACI) study


In this exercise we will continue to use the rearranged Dune Meadow data from exercise 24. A difference is that the plots are now divided into four groups:
    1. Control plots before a treatment (i.e. not treated)
    2. Control plots after a treatment (i.e. not treated)
    3. Impact plots before treatment (i.e. not treated)
    4. Impact plots after treatment (this is where the treatment is made)

The four groups are indicated in variable Treat in the environmental data set (EnvTS).
The question you want to answer is if the treatment caused a change in species composition that is significantly different from the change in the control plots.

```{r}

```

#### Question 26: SIMCA PLS STUFF
```{r}

```

#### Question 27 : Classification

Start by testing the non-hierarchical K-means clustering, using Multivar / K-Means. Note that it is recommended that K-means need at least 100 observations (500 according to some sources) to be reliable! Let us ignore the sample size issue for the moment, and ask for 4 clusters (for later comparison with the four management types). Test different hierarchical agglomeration algorithms and similarity indices. Use at least the Euclidian and the Bray-Curtis similarity measures for the hierarchical clustering technique. Try also the Ward’s method! Repeat the analysis above, but copy the Management types to a new grouping column.

```{r}
# install.packages("dendextend")
library(dendextend)

dune.dist <- vegdist(dune, method = "bray")

# K-Means Cluster Analysis
fit <- kmeans(dune.dist, 4, nstart = 25) # 4 cluster solution
#As the final result of k-means clustering result is sensitive to the random starting assignments, we specify nstart = 25. This means #that R will try 25 different random starting assignments and then select the best results corresponding to the one with the lowest #within cluster variation. The default value of nstart in R is one. But, it’s strongly recommended to compute k-means clustering with #a large value of nstart such as 25 or 50, in order to have a more stable result.
table(fit$cluster, dune.env.original$Management)
# append cluster assignment
dune.clusters <- data.frame(dune, fit$cluster)
dune.clusters <- data.frame(dune.clusters, dune.env.original$Management)

#try some approaches to hierarchical clustering
dend <- dune %>% # data
        dist(method = "euclidean") %>% # calculate a distance matrix, 
        hclust(method = "ward.D") %>% # Hierarchical clustering 
        as.dendrogram # Turn the object into a dendrogram.
plot(dend)




```

#### Question 28: ANOSIM
ANOSIM (ANalysis Of Similarities) is a non-parametric test of significant difference between two or more groups, based on any distance measure. In this case, use the clusters from the K-means exercise. Change to Bray-Curtis similarity index.

What does the result tell you? What other types of predefined clusters could you use?


```{r}
dune.dist <- vegdist(dune, method = "bray")
dune.ano <- anosim(dune.dist, fit$cluster)
summary(dune.ano)
plot(dune.ano)

dune.ano2 <- anosim(dune.dist, dune.env.original$Management)
summary(dune.ano2)
plot(dune.ano2)
```

#### Question 28: SIMPER
```{r}

sim <- simper(dune, dune.env.original$Management)
summary(sim)
#alternate
(sim <- with(dune.env.original, simper(dune, Management)))
summary(sim)
```

